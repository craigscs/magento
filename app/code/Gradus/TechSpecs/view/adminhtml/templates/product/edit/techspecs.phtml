<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css"
      xmlns="http://www.w3.org/1999/html">
<?php
$tech = $this->getProduct()->getData('tech_specs');
$info = json_decode($tech, true);
$count = 1;
?>

<div id='techspecs_container' class="techspec_header_container">
    <?php if (count($info) > 0) : ?>
    <?php foreach ($info as $head) : ?>
    <div id="header_container_<?= $count ?>" class="header_container">
        <h3>
            <div onclick="event.stopPropagation();" class="draggable-handle_headers" />
            <input style="width:400px;" onclick="event.stopPropagation()" class="admin__control-text" name="headers[<?= $count ?>][name]"
                   data-form-part="product_form" value="<?= $head['name'] ?>" />
            <a class="delete_icon" src="javascript:void(0)" onclick="deleteHeader('header_container_<?= $count ?>')">
                <img style="width:20px;" src="<?= $this->getViewFileUrl('Gradus_Catalog::images/trash.png') ?>"></a>
        </h3>
        <div>
            <table id="spec_table_<?= $count ?>" style="width:800px;" class="admin__dynamic-rows data-grid spectable">
                <thead>
                <tr>
                    <th class="data-grid-draggable-row-cell"></th>
                    <th class="data-grid-th position" style="width:30px"><span>Seq</span></th>
                    <th class="data-grid-th"><span>Spec Label</span></th>
                    <th class="data-grid-th"><span>Spec Value</span></th>
                    <th style="width:40px"/>
                </tr>
                </thead>
                <tbody>
                <?php $speccount = 1 ?>
                <?php foreach ($head['specs'] as $spec) : ?>
                <tr id="header_<?= $count ?>_specs_row_<?= $speccount ?>">
                    <td class="data-grid-draggable-row-cell">
                    <div class="draggable-handle_specs"></div>
                    </td>
                    <td class="posrow">
                        <?= $speccount ?>
                    </td>
                    <td>
                        <input class="admin__control-text" data-form-part="product_form" name="headers[<?= $count ?>][specs][<?= $speccount ?>][label]"
                               style="width:100%;" value="<?= $spec['label'] ?>" />
                    </td>
                    <td><textarea name="headers[<?= $count ?>][specs][<?= $speccount ?>][value]" data-form-part="product_form" style="width:100%;"><?= $spec['value'] ?></textarea></td>
                    <td><a onclick="deleteFeature('specs_row_<?= $speccount ?>')" href"#"><img src="<?= $this->getViewFileUrl('Gradus_Catalog::images/trash.png'); ?>" style="width:20px"></a></td>
                </tr>
            <?php endforeach ?>
                </tbody>
            </table>
            <button class="action-secondary" onclick="addSpec('spec_table_<?= $count ?>', <?= $count ?>)">Add spec</button>
        </div>
    </div>
    <?php endforeach ?>
    <?php endif ?>
</div>

<button class="action-secondary" style="margin-right:5px; margin-top:5px" onclick="addHeader()">Add Header</button>

<script>
    var $q = jQuery.noConflict();

    function updateaccord()
    {
        $q('#headers_container').append('').accordion("destroy").accordion({
            header: "> div > h3",
            autoHeight: false,
            collapsible: true,
        }).disableSelection();;

        $q('.spec_td').sortable({
            connectWith: "div.specs_row",
            revert: 300,
            handle: '.draggable-handle2',
            tolerance: "intersect",
            placeholder: "jqplaceholder",
            update: function( event, ui ) {
                $q('.specs_drag').each(function(i, obj) {
                    var ii = i+1;
                    $q(this).html(ii);
                })
            }
        }).disableSelection();
        $q('.spec_td').sortable('refresh');
    }

    $q( document ).ready(function() {
        $q('[name="product[tech_specs]"]').prev().prev().hide();

        $q('.techspec_header_container').accordion({
            header: "> div > h3",
            autoHeight: false,
            collapsible: true,
        }).sortable({ handle:
            '.draggable-handle_headers',
            revert: 300,
            tolerance: "intersect",
            update: function( event, ui ) {
                $q('.header_drag').each(function(i, obj) {
                    var ii = i+1;
                    $q(this).html(ii);
                })
            }
        }).disableSelection();

        $q('.spectable > tbody').sortable({
            revert: 300,
            handle: '.draggable-handle_specs',
            tolerance: "intersect",
            placeholder: "jqplaceholder",
            update: function( event, ui ) {
                $q('.specs_drag').each(function(i, obj) {
                    var ii = i+1;
                    $q(this).html(ii);
                })
            }
        }).disableSelection();
    });

    function addHeader()
    {
        var headcount = $q('.header_container').length+1;
        var q = '<div id="header_container_'+headcount+'" class="header_container">'+
            '<h3>'+
            '<div onclick="event.stopPropagation();" class="draggable-handle_headers" />'+
            '<input style="width:400px;" onclick="event.stopPropagation()" class="admin__control-text" name="headers['+headcount+'][name]"'+
            'data-form-part="product_form" value="" />'+
            '<a class="delete_icon" src="javascript:void(0)" onclick="deleteHeader(\'header_container_'+headcount+'\')">'+
            '<img style="width:20px;" src="<?= $this->getViewFileUrl('Gradus_Catalog::images/trash.png') ?>"></a>'+
                '</h3><div>'+
            '<table id="spec_table_'+headcount+'" style="width:800px;" class="admin__dynamic-rows data-grid spectable">'+
            '<thead><tr>'+
            '<th class="data-grid-draggable-row-cell"></th>'+
            '<th class="data-grid-th position" style="width:30px"><span>Seq</span></th>'+
            '<th class="data-grid-th"><span>Spec Label</span></th>'+
            '<th class="data-grid-th"><span>Spec Value</span></th>'+
            '<th style="width:40px"/></tr></thead>'+
            '<tbody><tr id="header_'+headcount+'_specs_row_1>">'+
            '<td class="data-grid-draggable-row-cell">'+
            '<div class="draggable-handle_specs"></div>'+
            '</td><td class="posrow"></td><td>'+
            '<input class="admin__control-text" data-form-part="product_form" name="headers['+headcount+'][specs][1][label]"'+
            'style="width:100%;" value="" /></td>'+
            '<td><textarea name="headers['+headcount+'][specs][1][value]" data-form-part="product_form" style="width:100%;"></textarea></td>'+
            '<td><a onclick="deleteFeature(\'header_'+headcount+'_specs_row_1\')" href"#"><img src="<?= $this->getViewFileUrl('Gradus_Catalog::images/trash.png'); ?>" style="width:20px"></a></td>'+
            '</tr></tbody></table>'+
            '<button class="action-secondary" onclick="addSpec(\'spec_table_'+headcount+'\', '+headcount+')">Add spec</button>' +
            '</div></div>'+
        '';
        $q('#techspecs_container').append(q);

        $q('.techspec_header_container').accordion('destroy').accordion({
            header: "> div > h3",
            autoHeight: false,
            collapsible: true,
        }).sortable({ handle:
            '.draggable-handle_headers',
            revert: 300,
            tolerance: "intersect",
            update: function( event, ui ) {
                $q('.header_drag').each(function(i, obj) {
                    var ii = i+1;
                    $q(this).html(ii);
                })
            }
        }).disableSelection();
        $q('.spectable > tbody').sortable({
            revert: 300,
            handle: '.draggable-handle_specs',
            tolerance: "intersect",
            placeholder: "jqplaceholder",
            update: function( event, ui ) {
                $q('.specs_drag').each(function(i, obj) {
                    var ii = i+1;
                    $q(this).html(ii);
                })
            }
        }).disableSelection();
    }

    function addSpec(appendTo, count)
    {
        var counts = $q('.spectable > tbody > tr').length+1;
        var q = '<tr id="specs_row_'+counts+'">'+
        '<td class="data-grid-draggable-row-cell">'+
        '<div class="draggable-handle_specs"></div>'+
        '</td>'+
        '<td class="posrow">'+
        counts+
        '</td>'+
        '<td>'+
        '<input class="admin__control-text" data-form-part="product_form" name="headers[1][specs][1][label]"'+
        'style="width:100%;" value="" />'+
        '</td>'+
        '<td><textarea name="headers['+count+'>][specs]['+counts+'][value]" data-form-part="product_form" style="width:100%;"></textarea></td>'+
        '<td><a onclick="deleteHeader(\'specs_row_'+counts+'\')" href"#"><img src="<?= $this->getViewFileUrl('Gradus_Catalog::images/trash.png'); ?>" style="width:20px"></a></td>'+
        '</tr>';
        $q('#'+appendTo).append(q);
    }

    function deleteHeader(id)
    {
        $q('#'+id).remove();
    }
</script>