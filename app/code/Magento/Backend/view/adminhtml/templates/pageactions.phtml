<?php
/**
 * Copyright Â© 2013-2017 Magento, Inc. All rights reserved.
 * See COPYING.txt for license details.
 */

// @codingStandardsIgnoreFile

?>
<?php if ($block->getChildHtml()):?>
    <div data-mage-init='{"floatingHeader": {}}' class="page-actions" <?php /* @escapeNotVerified */ echo $block->getUiId('content-header') ?>>
        <?php echo $block->getChildHtml(); ?>
        </div>
<?php endif; ?>


<div id="copy_from_div" style="display:none;">
    <div id="searchContainer" style="padding:10px;">
        <div class="admin__action-multiselect-search-wrap" style="width:400px; display:inline-block">
            <b>Search for an item</b>
            <select id="highlight_search">
            </select>
            <label class="admin__action-multiselect-search-label"></label>
        </div>
        <br>
        <b>Choose fields to copy</b>
        <br>
        <select multiple style="display: inline-block; max-height:250px; overflow:auto;" id="copy_items">
            <option value="name">Name</option>
            <option class="error_message" value="categories">Categories</option>
            <option value="highlights">Highlights</option>
            <option value="techspecs">Specifications</option>
            <option value="description">Description</option>
            <option value="short_description">Short Description</option>
            <option value="overview_note">Overview Note</option>
            <option value="InTheBox">Includes</option>
            <option value="features">Features</option>
            <option class="error_message" value="images">Images & Videos</option>
            <option value="metaKeywords">Meta Keywords</option>
            <option value="metaTitle">Meta Title</option>
            <option value="metaDescription">Meta Description</option>
            <option value="related">Related Products</option>
            <option value="accessories">Accessories</option>
            <option value="compatibility">Compatibility</option>
            <option class="error_message" values="downloads">Downloadable Files</option>
        </select>
        <div style="clear:both"></div>
        <button type="button" class="action-secondary" onclick="runCopy()" style="display:inline-block; margin-top:10px;">Copy fields</button>
        <br>
        <div id="copy_messages"></div>
    </div>
</div>

<script>
    function openCopyModal()
    {
        jQuery('#copy_from_div').modal();
        jQuery('#copy_from_div').modal("openModal");
    }

    function runCopy()
    {
        var fields = jQuery('#copy_items').val();
        var item = jQuery('#highlight_search').val();
        if (item == "") {
            alert("Please choose an item to copy from!");
            return;
        }
        if (fields != null) {
            jQuery('#copy_items').val().each(function (i, obj) {
                jQuery.ajax({
                    url: 'http://' + window.location.hostname + "/admin/catalog/product/copy/id/" + item + "/field/" + i + "/",
                    data: {form_key: window.FORM_KEY},
                    context: document.body
                }).success(function (res) {
                    if (res.res == null) {
                        jQuery('#copy_messages').append("<div class='error_message'>Nothing was found for "+res.field);
                        return;
                    }
                    if (res.dataindex != null &&
                        jQuery('[data-index="'+res.dataindex+'"] > div').attr('data-state-collapsible') != "open") {
                        jQuery('[data-index="'+res.dataindex+'"] > div').click();
                    }
                    if (res.field_type == "byName") {
                        copyfieldName(res.field, res.res);
                    }
                    if (res.field_type == "byId") {
                        copyfieldId(res.field, res.res);
                    }
                    if (res.field_type == "dynamic") {
                        window[res.func](res.res);
//                    copyfieldDynamic(res.func, res.res);
                    }
                    if (res.messages != null) {
                        jQuery.each(res.messages, function (k, v) {
                            jQuery('#copy_messages').append("<div class='" + k + "'>" + v + "</div>");
                        });
                    }
                })
            });
        } else {
            jQuery('#copy_messages').append("<div class='error_message'>Please select options above before running copy.");
        }
    }

    function copyfieldId(n, v)
    {
        jQuery('#'+n).html(v);
    }

    function copyfieldName(n, v)
    {
        jQuery('[name="'+n+'"]').val(v);
    }

    function setFields(vals)
    {
        jQuery.each(vals, function (i, v) {
            jQuery('#product_form_'+i).html(v);
            jQuery('#product_form_'+i).val(v);
        });
    }

    function copyitem(id, mfr)
    {
        jQuery('#searchPicked').val(id);
        jQuery('#picked_mfr').html(mfr);
    }
</script>